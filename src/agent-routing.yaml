# Agent Routing Configuration
# Determines which specialized agent to spawn based on story/file patterns
#
# This file enables "smart spawning" - the workflow analyzes each story
# and automatically selects the most appropriate specialized builder agent.
#
# =============================================================================
# AGENT DEFINITION HIERARCHY (H7)
# =============================================================================
# Each agent may appear in multiple files. This is the precedence order:
#
#   1. src/agents/{category}/{name}.md         ‚Äî AUTHORITATIVE persona definition
#   2. src/agent-routing.yaml (this file)      ‚Äî AUTHORITATIVE routing rules, persona name/emoji
#   3. src/workflows/*/workflow.yaml            ‚Äî Workflow-specific config (references, not definitions)
#   4. src/agents/*.agent.yaml                  ‚Äî BMAD web/UI rendering metadata (not runtime behavior)
#   5. src/adapters/{platform}/agents/*.md      ‚Äî Platform-adapted summaries (canonical source wins)
#
# When adding or modifying an agent:
#   - Update (1) for persona/behavior changes
#   - Update (2) for routing rule changes
#   - Adapters (5) should be regenerated from (1) periodically
#   - .agent.yaml (4) files are for BMAD UI only ‚Äî do not affect pipeline behavior
# =============================================================================


# =============================================================================
# PROJECT-LEVEL CONFIGURATION
# =============================================================================
# These can be overridden in project's _bmad/_config/pantheon.yaml

defaults:
  # Default model for all agents (can be overridden per-agent)
  model: "opus"

  # Fallback builder if no rules match
  fallback_builder: "general"

  # Whether to log routing decisions
  # When true, the orchestrator outputs which routing rule matched and why:
  #   "Routing: frontend-react matched (file_patterns: *.tsx, story_keywords: component)"
  #   "Routing: backend-typescript skipped (exclude_patterns: components/**/*.tsx present)"
  #   "Routing: general (fallback ‚Äî no specific builder matched)"
  log_routing: true

# =============================================================================
# BUILDER ROUTING RULES
# =============================================================================
# Evaluated in order - first match wins
#
# KEYWORD DISAMBIGUATION (M17):
# Some keywords appear in multiple builders. Order + exclude_patterns resolve conflicts:
#   "schema"   ‚Üí database-prisma (priority via priority_keywords) wins over api-graphql
#   "model"    ‚Üí database-prisma wins (evaluated before graphql)
#   "type"     ‚Üí api-graphql (only if *.graphql files present)
#   "API"      ‚Üí backend-typescript wins (exclude_patterns prevent frontend match)
#   "service"  ‚Üí backend-typescript (first match, but frontend-react excluded)
# When ambiguous, file_patterns are the stronger signal over story_keywords.
# Each rule specifies:
#   - id: unique identifier
#   - agent: path to agent prompt file (relative to src/)
#   - model: override model for this agent (optional)
#   - persona: agent persona name and emoji
#   - match: conditions that trigger this builder

builder_routing:

  # ---------------------------------------------------------------------------
  # FRONTEND BUILDERS
  # ---------------------------------------------------------------------------

  - id: frontend-react
    agent: "agents/builders/frontend-react.md"
    persona:
      name: "Helios"
      title: "Titan of the Sun & Frontend Radiance"
      emoji: "‚öõÔ∏è"
    match:
      # Match if story touches these file patterns
      file_patterns:
        - "*.tsx"
        - "*.jsx"
        - "components/**"
        - "app/**/page.tsx"
        - "app/**/layout.tsx"
        - "pages/**/*.tsx"
        - "src/components/**"
        - "src/features/**/*.tsx"
      # Match if story contains these keywords (case-insensitive)
      story_keywords:
        - "component"
        - "React"
        - "Next.js"
        - "UI"
        - "form"
        - "modal"
        - "dialog"
        - "button"
        - "layout"
        - "page"
        - "client component"
        - "server component"
      # Match if package.json has these dependencies
      package_indicators:
        - "react"
        - "next"
        - "@types/react"
      # Don't match if these patterns are present (prefer backend/database builders)
      exclude_patterns:
        - "api/**/*.ts"
        - "server/**/*.ts"
        - "prisma/**"

  - id: frontend-vue
    agent: "agents/builders/frontend-vue.md"
    persona:
      name: "Verdant"
      title: "Spirit of Progressive Enhancement"
      emoji: "üåø"
    match:
      file_patterns:
        - "*.vue"
        - "components/**/*.vue"
        - "pages/**/*.vue"
        - "composables/**"
      story_keywords:
        - "Vue"
        - "Nuxt"
        - "composable"
        - "Pinia"
      package_indicators:
        - "vue"
        - "nuxt"

  # ---------------------------------------------------------------------------
  # BACKEND BUILDERS
  # ---------------------------------------------------------------------------

  - id: backend-typescript
    agent: "agents/builders/backend-typescript.md"
    persona:
      name: "Hephaestus"
      title: "God of the Forge & Backend Craft"
      emoji: "üî•"
    match:
      file_patterns:
        - "api/**/*.ts"
        - "app/api/**/*.ts"
        - "server/**/*.ts"
        - "services/**/*.ts"
        - "lib/services/**/*.ts"
        - "lib/api/**/*.ts"
        - "src/server/**"
        - "src/api/**"
      story_keywords:
        - "API"
        - "endpoint"
        - "route"
        - "handler"
        - "middleware"
        - "service"
        - "controller"
        - "REST"
        - "server"
      # Don't match if these patterns are present (prefer frontend-react)
      exclude_patterns:
        - "components/**/*.tsx"
        - "app/**/page.tsx"

  - id: backend-python
    agent: "agents/builders/backend-python.md"
    persona:
      name: "Pythia"
      title: "Oracle of Pythonic Wisdom"
      emoji: "üêç"
    match:
      file_patterns:
        - "*.py"
        - "**/*.py"
        - "app/**/*.py"
        - "src/**/*.py"
      story_keywords:
        - "Python"
        - "Django"
        - "FastAPI"
        - "Flask"
        - "Celery"
        - "asyncio"
      package_indicators:
        - "fastapi"
        - "django"
        - "flask"

  - id: backend-go
    agent: "agents/builders/backend-go.md"
    persona:
      name: "Gopher"
      title: "Master of Concurrent Simplicity"
      emoji: "ü¶´"
    match:
      file_patterns:
        - "*.go"
        - "**/*.go"
        - "cmd/**"
        - "pkg/**"
        - "internal/**"
      story_keywords:
        - "Go"
        - "Golang"
        - "goroutine"
        - "channel"

  # ---------------------------------------------------------------------------
  # DATABASE BUILDERS
  # ---------------------------------------------------------------------------

  - id: database-prisma
    agent: "agents/builders/database-prisma.md"
    persona:
      name: "Athena"
      title: "Goddess of Wisdom & Data Architecture"
      emoji: "ü¶â"
    match:
      file_patterns:
        - "prisma/**"
        - "**/schema.prisma"
        - "**/migrations/**"
        - "prisma/schema.prisma"
      story_keywords:
        - "migration"
        - "database"
        - "schema"
        - "Prisma"
        - "model"
        - "relation"
        - "table"
        - "column"
        - "index"
        - "enum"
      # High priority - if story mentions database, use this builder
      priority_keywords:
        - "migration"
        - "schema change"
        - "add column"
        - "create table"
      # Don't match if these patterns dominate (prefer frontend/backend builders)
      exclude_patterns:
        - "components/**/*.tsx"
        - "app/**/page.tsx"

  - id: database-sql
    agent: "agents/builders/database-sql.md"
    persona:
      name: "Oracle"
      title: "Keeper of Relational Truth"
      emoji: "üìä"
    match:
      file_patterns:
        - "*.sql"
        - "migrations/**/*.sql"
        - "db/**/*.sql"
      story_keywords:
        - "SQL"
        - "PostgreSQL"
        - "MySQL"
        - "query"
        - "stored procedure"

  # ---------------------------------------------------------------------------
  # API BUILDERS
  # ---------------------------------------------------------------------------

  - id: api-graphql
    agent: "agents/builders/api-graphql.md"
    persona:
      name: "Mercury"
      title: "Messenger of Typed Queries"
      emoji: "‚ö°"
    match:
      file_patterns:
        - "*.graphql"
        - "**/*.graphql"
        - "resolvers/**"
        - "schema/**/*.graphql"
      story_keywords:
        - "GraphQL"
        - "resolver"
        - "mutation"
        - "subscription"
        - "schema"
        - "type"
      # Don't match if these patterns dominate (prefer database-prisma for schema work)
      exclude_patterns:
        - "prisma/**"
        - "**/schema.prisma"

  # ---------------------------------------------------------------------------
  # INFRASTRUCTURE BUILDERS
  # ---------------------------------------------------------------------------

  - id: infrastructure
    agent: "agents/builders/infrastructure.md"
    persona:
      name: "Atlas"
      title: "Titan of Infrastructure"
      emoji: "üåç"
    match:
      file_patterns:
        - "*.tf"
        - "terraform/**"
        - "Dockerfile"
        - "docker-compose*.yml"
        - ".github/workflows/**"
        - "k8s/**"
        - "helm/**"
      story_keywords:
        - "deploy"
        - "CI/CD"
        - "Docker"
        - "Terraform"
        - "infrastructure"
        - "Kubernetes"
        - "pipeline"
        - "GitHub Actions"

  # ---------------------------------------------------------------------------
  # TESTING BUILDERS
  # ---------------------------------------------------------------------------

  - id: testing
    agent: "agents/builders/testing.md"
    persona:
      name: "Aletheia"
      title: "Goddess of Truth & Test Revelation"
      emoji: "üéØ"
    match:
      file_patterns:
        - "**/*.test.ts"
        - "**/*.test.tsx"
        - "**/*.spec.ts"
        - "__tests__/**"
        - "e2e/**"
        - "cypress/**"
        - "playwright/**"
      story_keywords:
        - "test"
        - "testing"
        - "coverage"
        - "e2e"
        - "integration test"
        - "unit test"
      # Only match if story is primarily about testing
      require_primary_match: true

  # ---------------------------------------------------------------------------
  # FALLBACK - GENERAL BUILDER
  # ---------------------------------------------------------------------------

  - id: general
    agent: "agents/builders/general.md"
    persona:
      name: "Metis"
      title: "Titaness of Wisdom & Craft"
      emoji: "üî®"
    match:
      always: true  # Catch-all fallback

# =============================================================================
# REVIEWER ROUTING
# =============================================================================
# Determines which reviewers to spawn based on files touched

reviewer_routing:

  # Requirements review - ALWAYS included (highest priority)
  requirements:
    agent: "agents/reviewers/requirements.md"
    persona:
      name: "Eudaimonia"
      title: "Guardian of Requirements & Business Intent"
      emoji: "üìã"
    always_include: true
    priority: 0
    custom_override: "_config/custom/pantheon/agents/reviewers/requirements.md"

  # Security review - ALWAYS included
  security:
    agent: "agents/reviewers/security.md"
    persona:
      name: "Cerberus"
      title: "Guardian of the Gates"
      emoji: "üîê"
    always_include: true
    priority: 1

  # Architecture review - ALWAYS included
  architecture:
    agent: "agents/reviewers/architecture.md"
    persona:
      name: "Hestia"
      title: "Goddess of Structure & Integration"
      emoji: "üèõÔ∏è"
    always_include: true
    priority: 2

  # Performance review - included for backend/API work
  performance:
    agent: "agents/reviewers/performance.md"
    persona:
      name: "Apollo"
      title: "God of Logic & Performance"
      emoji: "‚ö°"
    match:
      file_patterns:
        - "api/**"
        - "services/**"
        - "lib/**"
        - "server/**"
      story_keywords:
        - "performance"
        - "optimization"
        - "cache"
        - "query"
        - "N+1"
    priority: 3

  # Accessibility review - included for frontend work
  accessibility:
    agent: "agents/reviewers/accessibility.md"
    persona:
      name: "Iris"
      title: "Rainbow Bridge of Accessibility"
      emoji: "üåà"
    match:
      file_patterns:
        - "*.tsx"
        - "*.jsx"
        - "*.vue"
        - "*.css"
        - "*.scss"
        - "components/**"
        - "pages/**"
      story_keywords:
        - "UI"
        - "form"
        - "button"
        - "modal"
        - "accessibility"
        - "a11y"
        - "ARIA"
    priority: 4

  # Quality review - included for complex stories
  quality:
    agent: "agents/reviewers/quality.md"
    persona:
      name: "Arete"
      title: "Spirit of Excellence"
      emoji: "‚ú®"
    match:
      complexity: "complex"  # Only for complex stories
    priority: 5

# =============================================================================
# VALIDATOR ROUTING
# =============================================================================

validator_routing:

  inspector:
    agent: "agents/validators/inspector.md"
    persona:
      name: "Argus"
      title: "The All-Seeing Inspector"
      emoji: "üîç"
    always_include: true

  test_quality:
    agent: "agents/validators/test-quality.md"
    persona:
      name: "Nemesis"
      title: "Goddess of Test Justice"
      emoji: "üß™"
    always_include: true

# =============================================================================
# COMPLEXITY ROUTING (Canonical Source ‚Äî v1)
# =============================================================================
# This is the single source of truth for complexity tiers.
# story-pipeline/workflow.yaml and batch-stories/workflow.yaml reference this.
# Tiers are evaluated by task count from the story file.

complexity_routing:
  tiers:
    trivial:
      max_tasks: 1
      review_mode: "consolidated"
      forging: "skip"
      description: "Minimal review for static/config changes"
      examples: ["README update", "config change", "copy fix"]

    micro:
      max_tasks: 2
      review_mode: "consolidated"
      forging: "skip"
      description: "Lightweight path for low-risk stories"
      examples: ["UI tweaks", "text changes", "simple CRUD"]

    light:
      max_tasks: 4
      review_mode: "consolidated"
      forging: "conditional"
      max_specialists: 1
      description: "Standard path with consolidated review"
      examples: ["Simple component", "basic form", "minor feature"]

    standard:
      max_tasks: 10
      review_mode: "consolidated"
      forging: "conditional"
      max_specialists: 2
      description: "Balanced path ‚Äî consolidated review sufficient"
      examples: ["API endpoints", "business logic", "data validation"]

    complex:
      min_tasks: 11
      max_tasks: 15
      review_mode: "parallel"
      forging: "always"
      max_specialists: 3
      description: "Enhanced validation ‚Äî parallel independent reviewers"
      examples: ["Auth", "payments", "security", "migrations"]

    critical:
      min_tasks: 16
      review_mode: "parallel"
      forging: "aggressive"
      max_specialists: 4
      description: "Maximum scrutiny ‚Äî all reviewers + aggressive forging"
      examples: ["Payment processing", "encryption", "PII handling"]

  # Risk keywords can promote a story to a higher tier
  risk_promotion:
    high_risk: ["auth", "security", "payment", "encryption", "migration", "database", "schema"]
    medium_risk: ["api", "integration", "external", "third-party", "cache"]
    low_risk: ["ui", "style", "config", "docs", "test"]
    promotion_rules:
      high_risk_keyword: "+2 tiers"
      medium_risk_keyword: "+1 tier"
      low_risk_keyword: "+0 tiers"

  # Token efficiency notes
  # - trivial‚Üístandard: consolidated multi-reviewer (saves ~60-70% of Phase 3 tokens)
  # - complex‚Üícritical: parallel reviewers (full independence for high-stakes code)
  # - All tiers: digest-first context, reflection_reporter (saves ~5-8K/story)

# =============================================================================
# SUPPORT AGENT ROUTING
# =============================================================================

support_routing:

  reflection:
    agent: "agents/support/reflection.md"
    persona:
      name: "Mnemosyne"
      title: "Titan of Memory & Learning"
      emoji: "üìö"

  arbiter:
    agent: "agents/support/arbiter.md"
    persona:
      name: "Themis"
      title: "Goddess of Justice & Triage"
      emoji: "‚öñÔ∏è"

  reporter:
    agent: "agents/support/reporter.md"
    persona:
      name: "Hermes"
      title: "Messenger of the Gods"
      emoji: "üìã"
